<!DOCTYPE html>
<html>

<head>
  <title>Speed Type - Lobby</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/favicon/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/styles/base.css">
  <link rel="stylesheet" type="text/css" href="/styles/game.css">
  <link rel="stylesheet" type="text/css" href="/styles/roomcreator.css">
</head>

<body>
  <div class="body-inner-mega-wrapper">
    <div class="everything-above-footer">
      <header>
        <div id="retro-logo-wrapper">
          <svg id=sun version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur id="glowfeGaussianBlur" stdDeviation="5.1" result="blur" />
              <feMerge>
                <feMergeNode in="blur" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
            <linearGradient id="outrun_grad" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#fde80d" />
              <stop offset="18%" stop-color="#fcd119" />
              <stop offset="33%" stop-color="#f9a92f" />
              <stop offset="48%" stop-color="#f68145" />
              <stop offset="63%" stop-color="#f24069" />
              <stop offset="76%" stop-color="#ef1c7d" />
              <stop offset="91%" stop-color="#ed008c" />
              <stop offset="100%" stop-color="#ed008c" />
            </linearGradient>
            <clipPath id="outrun">
              <rect x="0" y="0" width="200" height="60" />
              <rect x="0" y="62.5" width="200" height="10" />
              <rect x="0" y="76" width="200" height="10" />
              <rect x="0" y="91" width="200" height="10" />
              <rect x="0" y="107" width="200" height="9.5" />
              <rect x="0" y="124" width="200" height="9" />
              <rect x="0" y="140" width="200" height="8.5" />
              <rect x="0" y="155" width="200" height="8" />
              <rect x="0" y="170" width="200" height="7.5" />
            </clipPath>
            <circle cx="100" cy="100" r="100" clip-path="url(#outrun)" fill=url(#outrun_grad) filter=url(#glow) />
          </svg>
          <a href="/"><h1 class="glow">SPEED TYPER <span class="path-divider">></span> <span class="lobby-title">LOBBY</span></h1></a>
        </div>
      </header>

      <div class="lobby-container">
        <div class="lobby-section">
          <h3>Create a New Room</h3>
          <form class="create-room-form" id="create-room-form">
            <div class="form-group">
              <label for="creator-name-input">You:</label>
              <input 
                type="text" 
                id="creator-name-input" 
                class="creator-name-input" 
                placeholder="your name" 
                maxlength="10"
                autocomplete="off"
                required
              />
            </div>
            <div class="form-group">
              <label for="room-name-input">Room:</label>
              <input 
                type="text" 
                id="room-name-input" 
                class="room-name-input" 
                placeholder="Room name" 
                maxlength="10"
                autocomplete="off"
                required
              />
            </div>
            <button type="submit" class="button--create-room">CREATE ROOM</button>
          </form>
          <p class="error-message" id="create-error"></p>
        </div>

        <div class="or-divider">OR</div>

        <div class="lobby-section">
          <h3>Join an Existing Room</h3>
          <p>Ask for a room link, or select from active rooms below:</p>
          <div id="room-list" class="room-list">
            <p>Loading rooms...</p>
          </div>
        </div>
      </div>
    </div>
    <footer>
      Hagge â„¢
    </footer>
  </div>

  <script>
    const API_BASE = window.location.origin;
    
    // Preset a random name for the creator
    document.addEventListener('DOMContentLoaded', () => {
      const firstNames = [
        "Alice", "Bob", "Charlie", "Diana", "Eve", "Frank", "Grace", "Henry", "Ivy", "Jack",
        "Kate", "Liam", "Maya", "Noah", "Olivia", "Paul", "Quinn", "Ruby", "Sam", "Tara",
        "Uma", "Victor", "Willow", "Xander", "Yara", "Zoe", "Aiden", "Bella", "Caleb", "Demi"
      ];
      
      function getRandomName() {
        return firstNames[Math.floor(Math.random() * firstNames.length)];
      }
      
      document.getElementById("creator-name-input").value = getRandomName();
    });
    
    document.getElementById("create-room-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const creatorName = document.getElementById("creator-name-input").value.trim();
      const roomName = document.getElementById("room-name-input").value.trim();
      
      if (!creatorName || !roomName) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/rooms`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ name: roomName, creator: creatorName }),
        });
        
        if (response.ok) {
          const createdRoomJsonResponse = await response.json();
          const room = createdRoomJsonResponse.room;
          const roomUrl = `${window.location.origin}/room/${room.id}?creator=${encodeURIComponent(creatorName)}`;
          window.location.href = roomUrl;
        } else {
          const error = await response.json();
          document.getElementById("create-error").textContent = error.message || "Failed to create room";
          document.getElementById("create-error").style.display = "block";
        }
      } catch (error) {
        document.getElementById("create-error").textContent = "Connection error. Please try again.";
        document.getElementById("create-error").style.display = "block";
      }
    });
    
    function copyRoomLink() {
      const roomLink = document.getElementById("room-link").textContent;
      navigator.clipboard.writeText(roomLink).then(() => {
        document.getElementById("copy-success").style.display = "block";
        setTimeout(() => {
          document.getElementById("copy-success").style.display = "none";
        }, 2000);
      });
    }
    
    async function renderActiveRooms() {
      try {
        const response = await fetch(`${API_BASE}/api/rooms`);
        if (response.ok) {
          const jsonResponse = await response.json();
          const rooms = jsonResponse.rooms;
          const roomList = document.getElementById("room-list");
          
          if (rooms.length === 0) {
            roomList.innerHTML = "<p>No active rooms. Create one above!</p>";
          } else {
            roomList.innerHTML = rooms.map(room => `
              <div class="room-item">
                <div class="room-info">
                  <div class="room-name">${room.name}</div>
                  <div class="room-players">${room.playerCount} player${room.playerCount !== 1 ? "s" : ""}</div>
                </div>
                <button class="button button--join-room" onclick="joinRoom('${room.id}')">JOIN</button>
              </div>
            `).join("");
          }
        }
      } catch (error) {
        document.getElementById("room-list").innerHTML = "<p>Failed to load rooms</p>";
      }
    }
    
    function joinRoom(roomId) {
      window.location.href = `/room/${roomId}`;
    }
    
    renderActiveRooms();
    
    setInterval(renderActiveRooms, 5000);
  </script>
</body>

</html>